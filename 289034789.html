<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Pipeline</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    body { background:#000; margin:0; padding:0; height:100vh; overflow:hidden; }
    .square {
      width: 390px; height: 844px;
      margin:20px auto;
      border:6px solid #333; border-radius:28px;
      overflow:hidden; background:#111;
      display:flex; flex-direction:column;
    }
    .title-bar {
      display:grid; grid-template-columns:repeat(5,1fr); gap:8px;
      padding:16px 16px 8px; background:#111; flex-shrink:0;
    }
    .title { padding:12px 8px; text-align:center; font-weight:bold; font-size:16px; border-radius:10px; }

    /* UNIFIED SCROLL — ALL COLUMNS TOGETHER */
    .scroll-wrapper {
      flex:1;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling:touch;
      padding-bottom:160px;
    }
    .columns-grid {
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:8px;
      padding:0 16px;
      position:relative;
    }
    .divider { position:absolute; top:0; bottom:0; width:1px; background:rgba(255,255,255,0.15); pointer-events:none; z-index:10; }
    .divider:nth-child(1) { left:20%; } .divider:nth-child(2) { left:40%; }
    .divider:nth-child(3) { left:60%; } .divider:nth-child(4) { left:80%; }

    .column > div {
      min-height:100vh; /* ensures long columns don't break layout */
    }

    .card {
      background:#fff; color:#000; margin:6px 0; padding:8px 7px;
      border-radius:12px; font-size:11.5px; line-height:1.3;
      box-shadow:0 3px 8px rgba(0,0,0,0.5); cursor:grab;
      user-select:none; touch-action:pan-y;
      max-width:100%; box-sizing:border-box;
    }
    .card:active { cursor:grabbing; }
    .name { font-weight:bold; font-size:11.5px; margin-bottom:3px;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .tag { font-size:10px; padding:2px 7px; border-radius:7px; }
    .hot { background:#ef4444; color:white; }
    .warm { background:#f97316; color:white; }
    .cold { background:#6b7280; color:white; }
    .refresh-btn {
      background:#16a34a; color:white; font-weight:bold;
      padding:20px 80px; border-radius:50px; font-size:26px;
      box-shadow:0 6px 18px rgba(0,0,0,0.6);
    }
  </style>
</head>
<body>

<div class="square">
  <div class="title-bar">
    <div class="title bg-blue-600">New Lead</div>
    <div class="title bg-purple-600">Appt Set</div>
    <div class="title bg-green-600">Showed</div>
    <div class="title bg-orange-600">Sold</div>
    <div class="title bg-red-600">Lost</div>
  </div>

  <!-- UNIFIED SCROLL — ONE SCROLLER FOR ALL COLUMNS -->
  <div class="scroll-wrapper">
    <div class="columns-grid">
      <div class="divider"></div><div class="divider"></div><div class="divider"></div><div class="divider"></div>
      <div class="column"><div id="chatbot-lead"></div></div>
      <div class="column"><div id="appt-set"></div></div>
      <div class="column"><div id="showed"></div></div>
      <div class="column"><div id="sold"></div></div>
      <div class="column"><div id="lost"></div></div>
    </div>
  </div>

  <div style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); z-index:300;">
    <button id="refreshBtn" onclick="refreshPipeline()" class="refresh-btn">REFRESH</button>
  </div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzleiQlkUV9lQ4jo0jDeY2Wi2hqazb25c6_1gtC2faim5rSYBIRfbBRErKopGOM6fnVEg/exec';
let sortables = [];

async function refreshPipeline() {
  document.getElementById('refreshBtn').textContent = 'LOADING...';
  document.getElementById('refreshBtn').disabled = true;

  sortables.forEach(s => s.destroy());
  sortables = [];

  const res = await fetch(SCRIPT_URL + '?t=' + Date.now());
  const leads = await res.json();

  ['chatbot-lead','appt-set','showed','sold','lost'].forEach(id => document.getElementById(id).innerHTML = '');

  leads.forEach((lead, i) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.row = i + 2;

    const name = lead.Name || lead['C1: Name'] || '—';
    const lt = (lead['Lead Type'] || lead['A1: Lead Type'] || '').toLowerCase().trim();
    const hot = lt === 'hot';
    const cold = lt.includes('cold');

    card.innerHTML = `<div class="name">${name}</div>
      <span class="tag ${hot?'hot':cold?'cold':'warm'}">${hot?'HOT':cold?'COLD':'WARM'}</span>`;

    let target = 'chatbot-lead';
    const stage = (lead.Stage || lead.stage || '').toLowerCase();
    if (stage.includes('appt')) target = 'appt-set';
    else if (stage.includes('show')) target = 'showed';
    else if (stage.includes('sold')||stage.includes('delivered')) target = 'sold';
    else if (stage.includes('lost')) target = 'lost';

    document.getElementById(target).appendChild(card);
  });

  ['chatbot-lead','appt-set','showed','sold','lost'].forEach(id => {
    const s = new Sortable(document.getElementById(id), {
      group: 'pipeline',
      animation: 160,
      forceFallback: true,
      fallbackTolerance: 3,
      emptyInsertThreshold: 0,
      ghostClass: 'opacity-40',
      chosenClass: 'opacity-90',
      onEnd: e => fetch(`${SCRIPT_URL}?row=${e.item.dataset.row}&stage=${e.to.id}`, {method:'POST'})
    });
    sortables.push(s);
  });

  document.getElementById('refreshBtn').textContent = 'REFRESH';
  document.getElementById('refreshBtn').disabled = false;
}

refreshPipeline();
</script>
</body>
</html>